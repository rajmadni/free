<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bike Repair Shop Manager</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        :root {
            /* Changed color palette to a more 'shop' look (dark blue/grey) */
            --sidebar-width: 280px;
            --primary-color: #3f6081; /* Darker Blue/Grey for professional look */
            --secondary-color: #f7f9fc;
            --text-color: #212529;
            --border-radius: 0.5rem;
        }

        body {
            background-color: var(--secondary-color);
            color: var(--text-color);
            min-height: 100vh;
        }

        /* Sidebar Styling */
        #sidebar {
            width: var(--sidebar-width);
            background-color: #ffffff;
            color: var(--text-color);
            transition: all 0.3s;
            position: fixed;
            height: 100%;
            z-index: 1000;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
            padding-top: 56px; /* Space for the fixed navbar */
        }

        #sidebar .nav-link {
            color: var(--text-color);
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            margin: 0.25rem 0.5rem;
        }

        #sidebar .nav-link:hover, #sidebar .nav-link.active {
            background-color: var(--primary-color);
            color: #ffffff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Main Content Styling */
        #content-wrapper {
            margin-left: var(--sidebar-width);
            padding: 20px;
            transition: all 0.3s;
        }

        /* Responsive adjustments for mobile */
        @media (max-width: 768px) {
            #sidebar {
                width: 100%;
                height: auto;
                position: relative;
                padding-top: 0;
            }
            #content-wrapper {
                margin-left: 0;
                padding-top: 20px;
            }
            .navbar-brand {
                font-size: 1.1rem;
            }
        }

        /* Card and component styling */
        .card {
            border: none;
            border-radius: var(--border-radius);
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }

        .section-header {
            color: var(--primary-color);
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }
        
        /* Status Badges updated for Bike Shop flow */
        .status-badge-active { background-color: #ffc107; color: #212529; } /* Dropped Off / New Job */
        .status-badge-progress { background-color: #0dcaf0; color: #212529; } /* In Progress */
        .status-badge-ready { background-color: #198754; color: white; } /* Ready for Pickup */
        .status-badge-paid { background-color: #3f6081; color: white; } /* Paid & Closed */
        .status-badge-waiting { background-color: #dc3545; color: white; } /* Waiting for Parts/Approval */

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        .btn-primary:hover {
            background-color: #2f4d6d;
            border-color: #2f4d6d;
        }
        .text-primary {
            color: var(--primary-color) !important;
        }

        /* Login View Specific Styling (removed) */
        /* Since we reverted to auto-auth, the login view is no longer needed */
    </style>
</head>
<body>

    <!-- Main App Wrapper (Now default visible, Admin login is automatic via token) -->
    <div id="main-app-wrapper">
        <!-- Top Navigation Bar -->
        <nav class="navbar navbar-expand-md navbar-dark bg-primary shadow-sm fixed-top">
            <div class="container-fluid">
                <a class="navbar-brand fw-bold" href="#">Bike Shop Job Manager</a>
                <div class="d-flex align-items-center">
                    <!-- Logout Button (Removed - Auto sign-in means no manual logout) -->
                    <!-- Toggle button for mobile sidebar -->
                    <button class="btn btn-primary d-md-none" type="button" data-bs-toggle="collapse" data-bs-target="#sidebar" aria-controls="sidebar" aria-expanded="false" aria-label="Toggle navigation">
                        <i class="bi bi-list"></i>
                    </button>
                </div>
            </div>
        </nav>

        <div class="d-flex" id="wrapper">
            <!-- Sidebar -->
            <div class="d-none d-md-block" id="sidebar">
                <div class="list-group list-group-flush pt-4">
                    <a href="#dashboard-view" class="nav-link active" data-view="dashboard-view"><i class="bi bi-speedometer2 me-2"></i> Dashboard</a>
                    <a href="#add-job-view" class="nav-link" data-view="add-job-view"><i class="bi bi-tools me-2"></i> New Repair Job</a>
                    <a href="#jobs-view" class="nav-link" data-view="jobs-view"><i class="bi bi-bicycle me-2"></i> All Jobs</a>
                    <a href="#customers-view" class="nav-link" data-view="customers-view"><i class="bi bi-person-circle me-2"></i> Customers</a>
                    <a href="#invoices-view" class="nav-link" data-view="invoices-view"><i class="bi bi-receipt me-2"></i> Invoices</a>
                    <a href="#analytics-view" class="nav-link" data-view="analytics-view"><i class="bi bi-bar-chart-fill me-2"></i> Shop Analytics</a>
                    <a href="#settings-view" class="nav-link" data-view="settings-view"><i class="bi bi-gear-fill me-2"></i> Settings</a>
                </div>
            </div>

            <!-- Page Content -->
            <div id="content-wrapper">
                <div class="container-fluid pt-5">
                    <!-- User ID Display -->
                    <div class="alert alert-info py-2" role="alert">
                        <small>Admin User ID: <span id="current-user-id" class="fw-bold">Loading...</span></small>
                    </div>

                    <!-- 1. Dashboard View -->
                    <div class="app-view active" id="dashboard-view">
                        <h2 class="section-header">Shop Overview</h2>
                        <div class="row g-4 mb-4">
                            <div class="col-md-6 col-lg-3">
                                <div class="card p-3 bg-white shadow">
                                    <h5 class="card-title text-primary"><i class="bi bi-wrench me-2"></i> Jobs In Progress</h5>
                                    <p class="card-text fs-2 fw-bold" id="jobs-in-progress-count">0</p>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-3">
                                <div class="card p-3 bg-white shadow">
                                    <h5 class="card-title text-success"><i class="bi bi-cash-stack me-2"></i> Total Revenue (This Month)</h5>
                                    <p class="card-text fs-2 fw-bold" id="total-revenue-sum">$0.00</p>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-3">
                                <div class="card p-3 bg-white shadow">
                                    <h5 class="card-title text-warning"><i class="bi bi-bell me-2"></i> Ready for Pickup</h5>
                                    <p class="card-text fs-2 fw-bold" id="ready-for-pickup-count">0</p>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-3">
                                <div class="card p-3 bg-white shadow">
                                    <h5 class="card-title text-info"><i class="bi bi-person-fill me-2"></i> Total Customers</h5>
                                    <p class="card-text fs-2 fw-bold" id="total-customers-count">0</p>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-lg-6">
                                <div class="card p-4 mb-4">
                                    <h5 class="section-header">Bikes Due Soon</h5>
                                    <ul class="list-group list-group-flush" id="bikes-due-soon-list">
                                        <li class="list-group-item text-muted">No jobs due in the next week.</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="card p-4 mb-4">
                                    <h5 class="section-header">Pending Invoices</h5>
                                    <ul class="list-group list-group-flush" id="pending-invoices-list">
                                        <li class="list-group-item text-muted">No outstanding invoices.</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 2. Add Job View -->
                    <div class="app-view" id="add-job-view">
                        <h2 class="section-header">New Repair Job Entry</h2>
                        <div class="card p-4">
                            <form id="add-job-form">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="jobCustomer" class="form-label">Customer Name</label>
                                        <select class="form-select" id="jobCustomer" required>
                                            <option value="">Select a Customer</option>
                                            <!-- Options populated by JS/Firestore -->
                                        </select>
                                        <small class="form-text text-muted">Customer not listed? Add them in the Customers tab first.</small>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="jobTitle" class="form-label">Job Title / Summary</label>
                                        <input type="text" class="form-control" id="jobTitle" required placeholder="e.g., Full Tune-up and Brake Repair">
                                    </div>
                                </div>

                                <h5 class="mt-3 mb-3 text-primary">Bike Details</h5>
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label for="bikeMake" class="form-label">Make/Brand</label>
                                        <input type="text" class="form-control" id="bikeMake" required placeholder="e.g., Trek, Giant, Specialized">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="bikeModel" class="form-label">Model</label>
                                        <input type="text" class="form-control" id="bikeModel" placeholder="e.g., Domane AL 2">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="bikeSerial" class="form-label">Serial/ID (Optional)</label>
                                        <input type="text" class="form-control" id="bikeSerial">
                                    </div>
                                </div>

                                <h5 class="mt-3 mb-3 text-primary">Service & Cost</h5>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="jobEstimatedCost" class="form-label">Estimated Cost ($)</label>
                                        <input type="number" class="form-control" id="jobEstimatedCost" min="0" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="jobEstCompletionDate" class="form-label">Est. Completion Date</label>
                                        <input type="date" class="form-control" id="jobEstCompletionDate" required>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="jobServiceDescription" class="form-label">Service Required Description</label>
                                    <textarea class="form-control" id="jobServiceDescription" rows="3" placeholder="Customer complaint and initial assessment."></textarea>
                                </div>
                                <div id="job-form-message" class="mt-3"></div>
                                <button type="submit" class="btn btn-primary mt-3"><i class="bi bi-save me-2"></i> Drop Off & Save Job</button>
                            </form>
                        </div>
                    </div>

                    <!-- 3. Jobs View -->
                    <div class="app-view" id="jobs-view">
                        <h2 class="section-header">All Repair Jobs</h2>
                        <div class="card p-4">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle">
                                    <thead>
                                        <tr>
                                            <th>Job Title</th>
                                            <th>Customer</th>
                                            <th>Bike</th>
                                            <th>Est. Cost</th>
                                            <th>Due Date</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="jobs-table-body">
                                        <tr><td colspan="7" class="text-center text-muted">Loading jobs...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- 4. Customers View -->
                    <div class="app-view" id="customers-view">
                        <h2 class="section-header">Customer Management</h2>
                        <div class="row">
                            <div class="col-lg-4 mb-4">
                                <div class="card p-4">
                                    <h5 class="card-title">Add New Customer</h5>
                                    <form id="add-customer-form">
                                        <div class="mb-3">
                                            <label for="customerName" class="form-label">Customer Name</label>
                                            <input type="text" class="form-control" id="customerName" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="customerEmail" class="form-label">Email</label>
                                            <input type="email" class="form-control" id="customerEmail" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="customerPhone" class="form-label">Phone</label>
                                            <input type="text" class="form-control" id="customerPhone" required>
                                        </div>
                                        <div id="customer-form-message" class="mt-3"></div>
                                        <button type="submit" class="btn btn-success mt-3"><i class="bi bi-person-plus-fill me-2"></i> Add Customer</button>
                                    </form>
                                </div>
                            </div>
                            <div class="col-lg-8">
                                <div class="card p-4">
                                    <h5 class="card-title">All Customers</h5>
                                    <div class="table-responsive">
                                        <table class="table table-hover align-middle">
                                            <thead>
                                                <tr>
                                                    <th>Name</th>
                                                    <th>Email</th>
                                                    <th>Phone</th>
                                                    <th>Active Jobs</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="customers-table-body">
                                                <tr><td colspan="5" class="text-center text-muted">Loading customers...</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 5. Invoices View -->
                    <div class="app-view" id="invoices-view">
                        <h2 class="section-header">Invoice Tracking</h2>
                        <div class="card p-4 mb-4">
                            <h5 class="card-title">Record Payment for Invoice</h5>
                            <form id="add-invoice-form">
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label for="invoiceJob" class="form-label">Repair Job</label>
                                        <select class="form-select" id="invoiceJob" required>
                                            <option value="">Select Job</option>
                                            <!-- Options populated by JS/Firestore -->
                                        </select>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label for="invoiceAmount" class="form-label">Amount Paid ($)</label>
                                        <input type="number" class="form-control" id="invoiceAmount" min="0" required>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label for="invoiceDate" class="form-label">Date Paid</label>
                                        <input type="date" class="form-control" id="invoiceDate" required>
                                    </div>
                                    <div class="col-md-2 d-flex align-items-end mb-3">
                                        <button type="submit" class="btn btn-success w-100"><i class="bi bi-check2-circle"></i> Record Payment</button>
                                    </div>
                                </div>
                                <div id="invoice-form-message" class="mt-3"></div>
                            </form>
                        </div>

                        <div class="card p-4">
                            <h5 class="card-title">All Invoices</h5>
                            <div class="table-responsive">
                                <table class="table table-hover align-middle">
                                    <thead>
                                        <tr>
                                            <th>Job Title</th>
                                            <th>Customer</th>
                                            <th>Amount</th>
                                            <th>Date Paid</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="invoices-table-body">
                                        <tr><td colspan="6" class="text-center text-muted">Loading invoices...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- 6. Analytics View -->
                    <div class="app-view" id="analytics-view">
                        <h2 class="section-header">Shop Analytics</h2>
                        <div class="row g-4">
                            <div class="col-md-6">
                                <div class="card p-4">
                                    <h5>Job Status Distribution</h5>
                                    <div id="job-status-chart" class="p-3 text-center text-muted">
                                        <p>Loading data...</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card p-4">
                                    <h5>Revenue by Bike Brand (Top 5)</h5>
                                    <div id="revenue-by-brand-chart" class="p-3 text-center text-muted">
                                        <p>Loading data...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 7. Settings View -->
                    <div class="app-view" id="settings-view">
                        <h2 class="section-header">Settings & Data Management</h2>
                        <div class="card p-4">
                            <p class="lead">System Information</p>
                            <p>This application stores your data securely and privately in your provided Firebase Firestore instance.</p>
                            <hr>
                            <h5 class="text-danger">Danger Zone: Delete All Data</h5>
                            <p>This action cannot be undone. It will permanently remove all Jobs, Customers, and Invoices associated with your account.</p>
                            <button id="delete-all-data-btn" class="btn btn-danger"><i class="bi bi-trash-fill me-2"></i> Delete All My Data</button>
                            <div id="delete-data-message" class="mt-3"></div>
                        </div>
                    </div>

                    <!-- Confirmation Modal (for Delete Data) -->
                    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="confirmationModalLabel">Confirm Action</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    Are you absolutely sure you want to proceed? This is permanent. Type 'DELETE' to confirm.
                                    <input type="text" class="form-control mt-2" id="confirmationInput">
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn" disabled>Confirm Delete</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery and Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // Reverted imports to use token/anonymous sign-in methods
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, writeBatch, getDoc, setLogLevel, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        // Re-added initialAuthToken
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, currentUserId = null;
        let isAuthReady = false;

        // Data caches for faster lookups and analytics
        let allJobs = []; // Formerly allProjects
        let allCustomers = {}; // Keyed by customer ID, formerly allClients
        let allInvoices = []; // Formerly allPayments
        let allCustomersArray = []; // Array of customers for populating selects

        // Firestore Paths (Private Data)
        const getJobCollectionPath = (uid) => `artifacts/${appId}/users/${uid}/jobs`;
        const getCustomerCollectionPath = (uid) => `artifacts/${appId}/users/${uid}/customers`;
        const getInvoiceCollectionPath = (uid) => `artifacts/${appId}/users/${uid}/invoices`;

        // Utility Function for Formatting Currency
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
        };

        // Utility Function for Formatting Date
        const formatDate = (timestamp) => {
            if (timestamp && timestamp.toDate) {
                return timestamp.toDate().toLocaleDateString();
            }
            // Simple date string fallback for non-Firestore timestamp objects
            return new Date(timestamp).toLocaleDateString();
        };

        // --- 1. FIREBASE INITIALIZATION AND AUTHENTICATION (Reverted to token-based) ---

        window.onload = function() {
            // Set up Firebase configuration
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase configuration is missing. Cannot initialize Firestore.");
                $('#current-user-id').text('Error: Firebase Config Missing');
                return;
            }

            // Set debug log level to see all firestore logs
            setLogLevel('Debug');

            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Use session persistence
            setPersistence(auth, browserSessionPersistence).then(() => {
                // Sign in with custom token if available, otherwise sign in anonymously
                if (initialAuthToken) {
                    return signInWithCustomToken(auth, initialAuthToken);
                } else {
                    return signInAnonymously(auth);
                }
            }).catch((error) => {
                console.error("Authentication failed:", error);
                // Fallback to anonymous sign-in if custom token fails
                signInAnonymously(auth);
            });


            // Auth State Listener: Controls UI visibility
            onAuthStateChanged(auth, (user) => {
                isAuthReady = true;
                if (user) {
                    // User is signed in (Admin)
                    currentUserId = user.uid;
                    $('#current-user-id').text(currentUserId);
                    console.log("Admin authenticated (via token):", currentUserId);
                    
                    // Show App, Login is not needed
                    $('#main-app-wrapper').show();
                    
                    // Start listening to data once authenticated
                    setupFirestoreListeners();
                } else {
                    // This should generally not happen in this environment once loaded
                    currentUserId = null;
                    console.log("No user signed in. Data access denied.");
                    $('#main-app-wrapper').hide();
                }
            });
        };

        // --- 2. FIRESTORE LISTENERS (REAL-TIME DATA) ---

        function setupFirestoreListeners() {
            if (!isAuthReady || !db || !currentUserId) return;

            // Listener for Customers
            onSnapshot(collection(db, getCustomerCollectionPath(currentUserId)), (snapshot) => {
                allCustomers = {};
                allCustomersArray = [];
                $('#jobCustomer').empty().append('<option value="">Select a Customer</option>');
                snapshot.forEach(doc => {
                    const customer = { id: doc.id, ...doc.data() };
                    allCustomers[customer.id] = customer;
                    allCustomersArray.push(customer);
                    $('#jobCustomer').append(`<option value="${customer.id}">${customer.name}</option>`);
                });
                renderCustomersTable();
                updateDashboard();
            }, (error) => {
                console.error("Error listening to customers:", error);
                $('#customers-table-body').html('<tr><td colspan="5" class="text-center text-danger">Error loading customers.</td></tr>');
            });

            // Listener for Jobs
            onSnapshot(collection(db, getJobCollectionPath(currentUserId)), (snapshot) => {
                allJobs = [];
                $('#invoiceJob').empty().append('<option value="">Select Job</option>');
                snapshot.forEach(doc => {
                    const job = { id: doc.id, ...doc.data() };
                    allJobs.push(job);
                    $('#invoiceJob').append(`<option value="${job.id}">${job.jobTitle} (${allCustomers[job.customerId]?.name || 'N/A'})</option>`);
                });
                renderJobsTable();
                updateDashboard();
                updateAnalytics();
            }, (error) => {
                console.error("Error listening to jobs:", error);
                $('#jobs-table-body').html('<tr><td colspan="7" class="text-center text-danger">Error loading jobs.</td></tr>');
            });

            // Listener for Invoices
            onSnapshot(collection(db, getInvoiceCollectionPath(currentUserId)), (snapshot) => {
                allInvoices = [];
                snapshot.forEach(doc => {
                    allInvoices.push({ id: doc.id, ...doc.data() });
                });
                renderInvoicesTable();
                updateDashboard();
                updateAnalytics();
            }, (error) => {
                console.error("Error listening to invoices:", error);
                $('#invoices-table-body').html('<tr><td colspan="6" class="text-center text-danger">Error loading invoices.</td></tr>');
            });
        }

        // --- 3. RENDERING FUNCTIONS (UNCHANGED) ---

        function getStatusBadge(status) {
            let className = '';
            if (status === 'Dropped Off') className = 'status-badge-active';
            else if (status === 'In Progress') className = 'status-badge-progress';
            else if (status === 'Ready for Pickup') className = 'status-badge-ready';
            else if (status === 'Paid & Closed') className = 'status-badge-paid';
            else if (status === 'Waiting for Parts') className = 'status-badge-waiting';

            return `<span class="badge ${className} p-2">${status}</span>`;
        }

        function renderJobsTable() {
            const $tbody = $('#jobs-table-body');
            $tbody.empty();

            if (allJobs.length === 0) {
                const message = currentUserId ? 'No repair jobs found. Use the "New Repair Job" tab to get started.' : 'Please wait for login...';
                $tbody.append(`<tr><td colspan="7" class="text-center text-muted">${message}</td></tr>`);
                return;
            }

            allJobs.sort((a, b) => new Date(a.estimatedCompletionDate) - new Date(b.estimatedCompletionDate));

            allJobs.forEach(job => {
                const customer = allCustomers[job.customerId]?.name || 'Unknown Customer';
                const bikeDetails = `${job.bikeMake} (${job.bikeModel || 'N/A'})`;
                const row = `
                    <tr data-id="${job.id}">
                        <td>${job.jobTitle}</td>
                        <td>${customer}</td>
                        <td>${bikeDetails}</td>
                        <td>${formatCurrency(job.estimatedCost)}</td>
                        <td>${job.estimatedCompletionDate}</td>
                        <td>${getStatusBadge(job.status)}</td>
                        <td>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="bi bi-three-dots"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><span class="dropdown-header fw-bold">Update Status</span></li>
                                    <li><a class="dropdown-item update-status-btn" data-status="In Progress" href="#">In Progress</a></li>
                                    <li><a class="dropdown-item update-status-btn" data-status="Waiting for Parts" href="#">Waiting for Parts</a></li>
                                    <li><a class="dropdown-item update-status-btn" data-status="Ready for Pickup" href="#">Ready for Pickup</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item delete-job-btn text-danger" href="#">Delete Job</a></li>
                                </ul>
                            </div>
                        </td>
                    </tr>
                `;
                $tbody.append(row);
            });
        }

        function renderCustomersTable() {
            const $tbody = $('#customers-table-body');
            $tbody.empty();

            if (allCustomersArray.length === 0) {
                const message = currentUserId ? 'No customers found.' : 'Please wait for login...';
                $tbody.append(`<tr><td colspan="5" class="text-center text-muted">${message}</td></tr>`);
                return;
            }

            allCustomersArray.forEach(customer => {
                const activeJobCount = allJobs.filter(j => j.customerId === customer.id && j.status !== 'Paid & Closed').length;
                const row = `
                    <tr data-id="${customer.id}">
                        <td>${customer.name}</td>
                        <td><a href="mailto:${customer.email}">${customer.email}</a></td>
                        <td>${customer.phone}</td>
                        <td>${activeJobCount}</td>
                        <td>
                            <button class="btn btn-sm btn-danger delete-customer-btn" data-id="${customer.id}" title="Delete Customer"><i class="bi bi-trash"></i></button>
                        </td>
                    </tr>
                `;
                $tbody.append(row);
            });
        }

        function renderInvoicesTable() {
            const $tbody = $('#invoices-table-body');
            $tbody.empty();

            if (allInvoices.length === 0) {
                const message = currentUserId ? 'No invoices recorded.' : 'Please wait for login...';
                $tbody.append(`<tr><td colspan="6" class="text-center text-muted">${message}</td></tr>`);
                return;
            }

            allInvoices.sort((a, b) => new Date(b.datePaid) - new Date(a.datePaid));

            allInvoices.forEach(invoice => {
                const job = allJobs.find(j => j.id === invoice.jobId);
                const jobTitle = job ? job.jobTitle : 'Unknown Job';
                const customer = job ? (allCustomers[job.customerId]?.name || 'Unknown Customer') : 'N/A';
                const status = invoice.status || 'Paid & Closed';
                const row = `
                    <tr data-id="${invoice.id}">
                        <td>${jobTitle}</td>
                        <td>${customer}</td>
                        <td>${formatCurrency(invoice.amount)}</td>
                        <td>${formatDate(invoice.datePaid)}</td>
                        <td>${getStatusBadge(status)}</td>
                        <td>
                            <button class="btn btn-sm btn-danger delete-invoice-btn" data-id="${invoice.id}" title="Delete Invoice"><i class="bi bi-trash"></i></button>
                        </td>
                    </tr>
                `;
                $tbody.append(row);
            });
        }

        // --- 4. DASHBOARD/ANALYTICS UPDATE FUNCTIONS (UNCHANGED) ---

        function updateDashboard() {
            // Only update dashboard if a user is logged in
            if (!currentUserId) {
                $('#jobs-in-progress-count').text(0);
                $('#total-revenue-sum').text(formatCurrency(0));
                $('#ready-for-pickup-count').text(0);
                $('#total-customers-count').text(0);
                $('#bikes-due-soon-list').html('<li class="list-group-item text-muted">Please wait for authentication to load data.</li>');
                $('#pending-invoices-list').html('<li class="list-group-item text-muted">Please wait for authentication to load data.</li>');
                updateAnalytics(); // To clear charts
                return;
            }

            // Jobs In Progress
            const jobsInProgress = allJobs.filter(j => j.status === 'In Progress' || j.status === 'Waiting for Parts').length;
            $('#jobs-in-progress-count').text(jobsInProgress);

            // Total Revenue (Paid Invoices, past 30 days)
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

            const monthlyRevenue = allInvoices
                .filter(i => new Date(i.datePaid) >= thirtyDaysAgo)
                .reduce((sum, i) => sum + parseFloat(i.amount), 0);
            $('#total-revenue-sum').text(formatCurrency(monthlyRevenue));

            // Ready for Pickup
            const readyForPickup = allJobs.filter(j => j.status === 'Ready for Pickup').length;
            $('#ready-for-pickup-count').text(readyForPickup);

            // Total Customers
            $('#total-customers-count').text(allCustomersArray.length);


            // Bikes Due Soon (within next 7 days and not ready/closed)
            const now = new Date();
            const futureDate = new Date();
            futureDate.setDate(now.getDate() + 7);

            const bikesDueSoon = allJobs.filter(job => {
                const dueDate = new Date(job.estimatedCompletionDate);
                return (job.status === 'Dropped Off' || job.status === 'In Progress' || job.status === 'Waiting for Parts') && dueDate >= now && dueDate <= futureDate;
            });

            const $dueList = $('#bikes-due-soon-list').empty();
            if (bikesDueSoon.length === 0) {
                 $dueList.append('<li class="list-group-item text-muted">No jobs due in the next week.</li>');
            } else {
                bikesDueSoon.slice(0, 5).forEach(job => {
                    const dueDate = job.estimatedCompletionDate;
                    const customerName = allCustomers[job.customerId]?.name || 'Unknown';
                    $dueList.append(`
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            ${job.jobTitle} (${customerName})
                            <span class="badge bg-danger">${dueDate}</span>
                        </li>
                    `);
                });
            }

            // Pending Invoices (Jobs Ready for Pickup or Completed but not Paid)
            const pendingInvoices = allJobs
                .filter(j => j.status === 'Ready for Pickup')
                .slice(0, 5);

            const $pendingList = $('#pending-invoices-list').empty();
            if (pendingInvoices.length === 0) {
                $pendingList.append('<li class="list-group-item text-muted">No outstanding invoices.</li>');
            } else {
                pendingInvoices.forEach(job => {
                    $pendingList.append(`
                        <li class="list-group-item d-flex justify-content-between align-items-center text-warning">
                            ${job.jobTitle} (${allCustomers[job.customerId]?.name || 'N/A'})
                            <span class="fw-bold">${formatCurrency(job.estimatedCost)}</span>
                        </li>
                    `);
                });
            }
        }

        function updateAnalytics() {
            if (!currentUserId) {
                $('#job-status-chart').html('<p>Please wait for authentication to load data.</p>');
                $('#revenue-by-brand-chart').html('<p>Please wait for authentication to load data.</p>');
                return;
            }

            // --- Job Status Distribution ---
            const statusCounts = allJobs.reduce((acc, job) => {
                acc[job.status] = (acc[job.status] || 0) + 1;
                return acc;
            }, {});

            let statusHtml = '';
            if (Object.keys(statusCounts).length === 0) {
                 statusHtml = '<p>No job data to display.</p>';
            } else {
                statusHtml = Object.entries(statusCounts).map(([status, count]) => {
                    const total = allJobs.length;
                    const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
                    return `
                        <div class="mb-2">
                            <span class="me-2">${getStatusBadge(status)}</span>
                            <span class="fw-bold">${count} Jobs</span> (${percentage}%)
                        </div>
                        <div class="progress mb-3" style="height: 10px;">
                            <div class="progress-bar ${status === 'Ready for Pickup' ? 'bg-success' : status === 'In Progress' ? 'bg-info' : 'bg-secondary'}"
                                role="progressbar" style="width: ${percentage}%" aria-valuenow="${percentage}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    `;
                }).join('');
            }
            $('#job-status-chart').html(statusHtml);

            // --- Revenue by Bike Brand ---
            const revenueByBrand = allInvoices
                .filter(i => i.status === 'Paid & Closed')
                .reduce((acc, invoice) => {
                    const job = allJobs.find(j => j.id === invoice.jobId);
                    if (job) {
                        const brand = job.bikeMake || 'Unknown Brand';
                        acc[brand] = (acc[brand] || 0) + parseFloat(invoice.amount);
                    }
                    return acc;
                }, {});

            const sortedBrands = Object.entries(revenueByBrand)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 5); // Top 5

            const totalRevenue = Object.values(revenueByBrand).reduce((sum, amount) => sum + amount, 0);

            let brandHtml = '';
            if (sortedBrands.length === 0) {
                brandHtml = '<p>No paid revenue data to display.</p>';
            } else {
                brandHtml = sortedBrands.map(([name, amount]) => {
                    const percentage = totalRevenue > 0 ? ((amount / totalRevenue) * 100).toFixed(1) : 0;
                    return `
                        <div class="mb-2">
                            <span class="fw-bold">${name}</span>: ${formatCurrency(amount)} (${percentage}%)
                        </div>
                        <div class="progress mb-3" style="height: 10px;">
                            <div class="progress-bar bg-primary" role="progressbar" style="width: ${percentage}%" aria-valuenow="${percentage}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    `;
                }).join('');
            }
            $('#revenue-by-brand-chart').html(brandHtml);
        }

        // --- 5. JQUERY UI AND EVENT HANDLERS ---

        $(document).ready(function() {
            // Navigation Handler
            $('#sidebar .nav-link').on('click', function(e) {
                e.preventDefault();
                const viewId = $(this).data('view');

                $('#sidebar .nav-link').removeClass('active');
                $(this).addClass('active');

                $('.app-view').removeClass('active').hide();
                $(`#${viewId}`).addClass('active').show();

                // On mobile, collapse the sidebar after clicking
                if ($(window).width() < 768) {
                    $('#sidebar').collapse('hide');
                }
            });

            // --- AUTHENTICATION HANDLERS (Login/Logout removed, now automatic) ---

            // Note: Login/Logout handlers were removed to fix the Firebase configuration error.

            // --- DATA CRUD Handlers (Unchanged logic, just ensure currentUserId check is fine) ---

            // Add Job
            $('#add-job-form').on('submit', async function(e) {
                e.preventDefault();
                if (!currentUserId) return; // Must be logged in

                const jobTitle = $('#jobTitle').val().trim();
                const customerId = $('#jobCustomer').val();
                const estimatedCost = parseFloat($('#jobEstimatedCost').val());
                const estimatedCompletionDate = $('#jobEstCompletionDate').val();
                const serviceDescription = $('#jobServiceDescription').val().trim();
                const bikeMake = $('#bikeMake').val().trim();
                const bikeModel = $('#bikeModel').val().trim();
                const bikeSerialNumber = $('#bikeSerial').val().trim();

                if (!customerId) {
                    $('#job-form-message').html('<div class="alert alert-warning">Please select a valid customer. Add one in the **Customers** tab first if needed.</div>');
                    setTimeout(() => $('#job-form-message').empty(), 5000);
                    return; // Stop execution if customer is missing
                }


                const newJob = {
                    jobTitle,
                    customerId,
                    estimatedCost,
                    estimatedCompletionDate,
                    serviceDescription,
                    bikeMake,
                    bikeModel,
                    bikeSerialNumber,
                    status: 'Dropped Off', // Initial status
                    createdAt: new Date().toISOString()
                };

                try {
                    await addDoc(collection(db, getJobCollectionPath(currentUserId)), newJob);
                    $('#job-form-message').html('<div class="alert alert-success">Job added successfully! Bike is Dropped Off.</div>');
                    $(this).trigger('reset');
                } catch (error) {
                    console.error("Error adding job:", error);
                    $('#job-form-message').html('<div class="alert alert-danger">Error saving job. Check console for details.</div>');
                }
                setTimeout(() => $('#job-form-message').empty(), 3000);
            });

            // Add Customer (Formerly Add Client)
            $('#add-customer-form').on('submit', async function(e) {
                e.preventDefault();
                if (!currentUserId) return; // Must be logged in

                const name = $('#customerName').val().trim();
                const email = $('#customerEmail').val().trim();
                const phone = $('#customerPhone').val().trim();

                const newCustomer = { name, email, phone };

                try {
                    await addDoc(collection(db, getCustomerCollectionPath(currentUserId)), newCustomer);
                    $('#customer-form-message').html('<div class="alert alert-success">Customer added successfully!</div>');
                    $(this).trigger('reset');
                } catch (error) {
                    console.error("Error adding customer:", error);
                    $('#customer-form-message').html('<div class="alert alert-danger">Error saving customer. Check console for details.</div>');
                }
                setTimeout(() => $('#customer-form-message').empty(), 3000);
            });

            // Add Invoice (Formerly Add Payment)
            $('#add-invoice-form').on('submit', async function(e) {
                e.preventDefault();
                if (!currentUserId) return; // Must be logged in

                const jobId = $('#invoiceJob').val();
                const amount = parseFloat($('#invoiceAmount').val());
                const datePaid = $('#invoiceDate').val();

                if (!jobId) {
                     $('#invoice-form-message').html('<div class="alert alert-warning">Please select a Job to record payment for.</div>');
                     setTimeout(() => $('#invoice-form-message').empty(), 3000);
                     return;
                }

                const newInvoice = {
                    jobId,
                    amount,
                    datePaid,
                    status: 'Paid & Closed', // Payment recorded = job closed
                    createdAt: new Date().toISOString()
                };

                const batch = writeBatch(db);

                // 1. Record the Invoice/Payment
                const invoiceRef = doc(collection(db, getInvoiceCollectionPath(currentUserId)));
                batch.set(invoiceRef, newInvoice);

                // 2. Update the Job status to 'Paid & Closed'
                const jobRef = doc(db, getJobCollectionPath(currentUserId), jobId);
                batch.update(jobRef, { status: 'Paid & Closed' });

                try {
                    await batch.commit();
                    $('#invoice-form-message').html('<div class="alert alert-success">Payment recorded and Job marked Paid & Closed successfully!</div>');
                    $(this).trigger('reset');
                } catch (error) {
                    console.error("Error recording invoice/payment:", error);
                    $('#invoice-form-message').html('<div class="alert alert-danger">Error saving payment. Check console for details.</div>');
                }
                setTimeout(() => $('#invoice-form-message').empty(), 5000);
            });

            // Update Job Status
            $('#jobs-table-body').on('click', '.update-status-btn', async function(e) {
                e.preventDefault();
                if (!currentUserId) return; // Must be logged in
                const jobId = $(this).closest('tr').data('id');
                const newStatus = $(this).data('status');

                console.warn(`Attempting to change job status to ${newStatus}. Confirmation bypassed.`);
                try {
                    await updateDoc(doc(db, getJobCollectionPath(currentUserId), jobId), {
                        status: newStatus
                    });
                    console.log(`Job ${jobId} status updated to ${newStatus}`);
                } catch (error) {
                    console.error("Error updating job status:", error);
                }
            });


            // Delete Job
            $('#jobs-table-body').on('click', '.delete-job-btn', async function(e) {
                e.preventDefault();
                if (!currentUserId) return; // Must be logged in
                const jobId = $(this).closest('tr').data('id');

                console.warn(`Attempted to delete job ${jobId}. Confirmation bypassed.`);

                try {
                    await deleteDoc(doc(db, getJobCollectionPath(currentUserId), jobId));
                    console.log(`Job ${jobId} deleted.`);
                } catch (error) {
                    console.error("Error deleting job:", error);
                }
            });

            // Delete Customer
            $('#customers-table-body').on('click', '.delete-customer-btn', async function(e) {
                e.preventDefault();
                if (!currentUserId) return; // Must be logged in
                const customerId = $(this).data('id');
                const activeJobCount = allJobs.filter(j => j.customerId === customerId && j.status !== 'Paid & Closed').length;

                console.warn(`Attempted to delete customer ${customerId} with ${activeJobCount} active jobs. Confirmation bypassed.`);

                if (activeJobCount > 0) {
                     console.error(`Cannot delete customer ${customerId}: ${activeJobCount} active jobs still exist.`);
                     // Using browser alert() here only as a fallback for the custom modal which isn't implemented for this specific action
                     alert(`Cannot delete customer. Please close their ${activeJobCount} active job(s) first.`);
                     return;
                }

                try {
                    await deleteDoc(doc(db, getCustomerCollectionPath(currentUserId), customerId));
                    console.log(`Customer ${customerId} deleted.`);
                } catch (error) {
                    console.error("Error deleting customer:", error);
                }
            });

            // Delete Invoice
            $('#invoices-table-body').on('click', '.delete-invoice-btn', async function(e) {
                e.preventDefault();
                if (!currentUserId) return; // Must be logged in
                const invoiceId = $(this).data('id');

                console.warn(`Attempted to delete invoice ${invoiceId}. Confirmation bypassed.`);

                try {
                    await deleteDoc(doc(db, getInvoiceCollectionPath(currentUserId), invoiceId));
                    console.log(`Invoice ${invoiceId} deleted.`);
                } catch (error) {
                    console.error("Error deleting invoice:", error);
                }
            });


            // --- Settings / Delete All Data Handler ---

            $('#delete-all-data-btn').on('click', function() {
                if (!currentUserId) {
                    $('#delete-data-message').html('<div class="alert alert-warning">Please wait for authentication to load data.</div>');
                    return;
                }
                // Show Bootstrap Modal for Confirmation
                const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
                modal.show();
            });

            // Confirmation input listener
            $('#confirmationInput').on('keyup', function() {
                const isConfirmed = $(this).val() === 'DELETE';
                $('#confirmDeleteBtn').prop('disabled', !isConfirmed);
            });

            // Final Delete Execution
            $('#confirmDeleteBtn').on('click', async function() {
                if ($('#confirmationInput').val() !== 'DELETE' || !currentUserId) return;

                const $btn = $(this);
                $btn.prop('disabled', true).text('Deleting...');
                $('#delete-data-message').empty();
                const modal = bootstrap.Modal.getInstance(document.getElementById('confirmationModal'));

                try {
                    // Function to delete all documents in a collection
                    const deleteAllInCollection = async (collectionPath) => {
                        const batch = writeBatch(db);
                        const q = collection(db, collectionPath);
                        const snapshot = await getDocs(q);
                        snapshot.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        await batch.commit();
                        console.log(`All documents deleted from ${collectionPath}`);
                    };

                    await deleteAllInCollection(getJobCollectionPath(currentUserId));
                    await deleteAllInCollection(getCustomerCollectionPath(currentUserId));
                    await deleteAllInCollection(getInvoiceCollectionPath(currentUserId));

                    $('#delete-data-message').html('<div class="alert alert-success">All data successfully deleted.</div>');
                    modal.hide();

                } catch (error) {
                    console.error("Error deleting all data:", error);
                    $('#delete-data-message').html('<div class="alert alert-danger">Error during bulk deletion. Check console for details.</div>');
                } finally {
                    $btn.prop('disabled', false).text('Confirm Delete');
                    $('#confirmationInput').val('');
                }
            });

        });
    </script>
</body>
</html>
